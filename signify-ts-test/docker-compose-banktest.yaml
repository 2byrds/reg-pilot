services:
  vlei-server:
    image: gleif/vlei
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONIOENCODING=UTF-8
    command:
      - vLEI-server
      - -s
      - ./schema/acdc
      - -c
      - ./samples/acdc/
      - -o
      - ./samples/oobis/
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:7723/oobi/EBfdlu8R27Fbx-ehrqwImnK-8Cm79sqbAQ4MmvEAYqao
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 2s
    ports:
      - 7723:7723

  keria:
    image: ${BANK_KERIA_IMAGE:-ronakseth96/keria:latest}
    environment:
      - KERI_AGENT_CORS=1
      - KERI_URL=http://keria:3902
      - PYTHONUNBUFFERED=1
      - PYTHONIOENCODING=UTF-8
    volumes:
      - ./config/testkeria.json:/keria/config/keri/cf/keria.json
    entrypoint:
      [
        "keria",
        "start",
        "--config-dir",
        "/keria/config",
        "--config-file",
        "keria",
        "--name",
        "agent",
      ]
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://keria:3902/spec.yaml"]
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 2s
    ports:
      - 3901:3901
      - 3902:3902
      - 3903:3903

  witness-demo:
    image: weboftrust/keri-witness-demo:1.1.0
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONIOENCODING=UTF-8
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5642/oobi"]
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 2s
    volumes:
      - ./config/witness-demo:/keripy/scripts/keri/cf/main
    ports:
      - 5642:5642
      - 5643:5643
      - 5644:5644

  reg-pilot-api:
    image: gleif/reg-pilot-api:dev
    ports:
      - 8000:8000
    environment:
      - ENABLE_CORS=true
      - VERIFIER_AUTHORIZATIONS=http://vlei-verifier:7676/authorizations/
      - VERIFIER_PRESENTATIONS=http://vlei-verifier:7676/presentations/
      - FILER_REPORTS=http://reg-pilot-filer:7878/reports/
      - VERIFIER_REPORTS=http://vlei-verifier:7676/reports/
      - VERIFIER_REQUESTS=http://vlei-verifier:7676/request/verify/
      - VERIFIER_ADD_ROT=http://vlei-verifier:7676/root_of_trust/
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://reg-pilot-api:8000/ping"]
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 2s

  vlei-verifier:
    image: gleif/vlei-verifier:latest
    container_name: vlei-verifier
    hostname: vlei-verifier
    depends_on:
      - vlei-server
      - witness-demo
    ports:
      - 7676:7676
    environment:
      - KERI_BASER_MAP_SIZE=1500000000
      - FILER_CHUNK_SIZE=5000000
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://vlei-verifier:7676/health"]
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 2s

  reg-pilot-filer:
    image: gleif/reg-pilot-filer:dev
    container_name: reg-pilot-filer
    hostname: reg-pilot-filer
    ports:
      - 7878:7878
    environment:
      - VLEI_VERIFIER=http://vlei-verifier:7676
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://reg-pilot-filer:7878/health"]
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 2s

  verify:
    image: alpine
    command: ["echo", "Dependencies running"]
    depends_on:
      reg-pilot-api:
        condition: service_healthy
      vlei-verifier:
        condition: service_healthy
      reg-pilot-filer:
        condition: service_healthy
